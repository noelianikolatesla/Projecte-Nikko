'use strict';

var uuid = require('@smithy/uuid');
var protocolHttp = require('@smithy/protocol-http');

const eventStreamPayloadHandler = {
    handle: (next, args) => next(args),
};

const injectResponseValuesMiddleware = (config) => (next) => async (args) => {
    if (args.input.SessionId === undefined && isWebSocket(config)) {
        args.input.SessionId = uuid.v4();
    }
    const requestParams = {
        ...args.input,
    };
    const response = await next(args);
    const output = response.output;
    for (const key of Object.keys(output)) {
        if (output[key] === undefined && requestParams[key]) {
            output[key] = requestParams[key];
        }
    }
    return response;
};
const isWebSocket = (config) => config.requestHandler.metadata?.handlerProtocol?.includes("websocket");
const injectResponseValuesMiddlewareOptions = {
    step: "initialize",
    name: "injectResponseValuesMiddleware",
    tags: ["WEBSOCKET", "EVENT_STREAM"],
    override: true,
};

const websocketPortMiddleware = (options) => (next) => (args) => {
    const { request } = args;
    if (protocolHttp.HttpRequest.isInstance(request) && options.requestHandler.metadata?.handlerProtocol?.includes("websocket")) {
        request.hostname = `${request.hostname}:8443`;
        request.headers.host = request.hostname;
    }
    return next(args);
};
const websocketPortMiddlewareOptions = {
    name: "websocketPortMiddleware",
    tags: ["WEBSOCKET", "EVENT_STREAM", "PORT"],
    relation: "after",
    toMiddleware: "eventStreamHeaderMiddleware",
    override: true,
};

const getTranscribeStreamingPlugin = (config) => ({
    applyToStack: (clientStack) => {
        clientStack.addRelativeTo(websocketPortMiddleware(config), websocketPortMiddlewareOptions);
        clientStack.add(injectResponseValuesMiddleware(config), injectResponseValuesMiddlewareOptions);
    },
});

exports.eventStreamPayloadHandler = eventStreamPayloadHandler;
exports.getTranscribeStreamingPlugin = getTranscribeStreamingPlugin;
exports.injectResponseValuesMiddleware = injectResponseValuesMiddleware;
exports.injectResponseValuesMiddlewareOptions = injectResponseValuesMiddlewareOptions;
exports.websocketPortMiddleware = websocketPortMiddleware;
exports.websocketPortMiddlewareOptions = websocketPortMiddlewareOptions;
